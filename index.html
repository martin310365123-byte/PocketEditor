<!doctype html>
const closeX = document.getElementById('consent-close');
const checkbox = document.getElementById('consent-check');


let pendingUrl = null; let pendingNewTab = false;
const NEED = /\/releases\/|\.exe$|\.msi$|\.zip$/i;
const hasAccepted = () => false; // 永遠每次詢問（不記錄）


function openModal(url, openInNewTab){
pendingUrl = url; pendingNewTab = !!openInNewTab;
checkbox.checked = false; agreeBtn.disabled = true;
modal.style.display = 'flex';
modal.classList.add('show');
modal.setAttribute('aria-hidden','false');
}
function closeModal(){
modal.classList.remove('show');
modal.setAttribute('aria-hidden','true');
modal.style.display = 'none';
}


checkbox.addEventListener('change', ()=>{ agreeBtn.disabled = !checkbox.checked; });
cancelBtn.addEventListener('click', ()=>{ pendingUrl=null; pendingNewTab=false; closeModal(); });
closeX.addEventListener('click', ()=>{ pendingUrl=null; pendingNewTab=false; closeModal(); });
modal.addEventListener('click', (e)=>{ if(e.target===modal){ pendingUrl=null; pendingNewTab=false; closeModal(); } });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ pendingUrl=null; pendingNewTab=false; closeModal(); } });


function needConsentFor(el){
const url = (el.getAttribute('data-href') || el.getAttribute('href') || '').trim();
if(!url) return null;
if(el.hasAttribute('data-need-consent')) return url;
if(NEED.test(url)) return url;
return null;
}
function bind(el){
if(!el || el.dataset.consentBound==='1') return;
const url = needConsentFor(el);
if(!url) return;
el.setAttribute('data-href', url);
if(el.tagName.toLowerCase()==='a'){
el.removeAttribute('href');
el.setAttribute('role','button');
el.setAttribute('tabindex','0');
}
const handler = (openNew)=>{
if(hasAccepted()){
if(openNew) window.open(url,'_blank'); else window.location.assign(url);
return;
}
openModal(url, !!openNew);
};
el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); }, true);
el.addEventListener('click', (e)=>{ e.preventDefault(); handler(e.metaKey||e.ctrlKey||el.target==='_blank'); }, true);
el.addEventListener('auxclick', (e)=>{ if(e.button===1){ e.preventDefault(); handler(true); } }, true);
el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handler(false); } }, true);
el.dataset.consentBound='1';
}
function scanAll(){ document.querySelectorAll('a,button').forEach(bind); }
scanAll();
const mo = new MutationObserver(()=>{ scanAll(); });
mo.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['href','data-href'] });


agreeBtn.addEventListener('click', ()=>{
if(checkbox.checked && pendingUrl){
const url = pendingUrl; const openNew = pendingNewTab;
pendingUrl=null; pendingNewTab=false; closeModal();
if(openNew) window.open(url,'_blank'); else window.location.assign(url);
}
});
})();
</script>
</body>
</html>
